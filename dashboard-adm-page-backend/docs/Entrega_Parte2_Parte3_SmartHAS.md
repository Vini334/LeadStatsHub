# Smart HAS — Entrega Parte 2 & Parte 3 (Oracle + PL/SQL + Integração)

## Sumário
- [Visão Geral](#visão-geral)
- [Parte 2 — Integração Oracle](#parte-2--integração-oracle)
  - [Modelo Lógico/Físico (DER)](#modelo-lógicofísico-der)
  - [DDL das Tabelas Principais](#ddl-das-tabelas-principais)
  - [Dados Simulados](#dados-simulados)
  - [Passo a Passo de Implantação](#passo-a-passo-de-implantação)
- [Parte 3 — Funções e Procedures (PL/SQL)](#parte-3--funções-e-procedures-plsql)
  - [Functions](#functions)
  - [Procedures](#procedures)
  - [Integração Java ⇄ Oracle](#integração-java--oracle)
- [Testes & Evidências](#testes--evidências)
- [Checklist de Conformidade](#checklist-de-conformidade)
- [Troubleshooting](#troubleshooting)
- [Apêndice](#apêndice)

## Visão Geral
O Smart HAS é um ecossistema de monitoramento e engajamento social composto por um frontend Angular (`ProjetoAngular/lead-stats-hub-ng`) e um backend Spring Boot (`dashboard-adm-page-backend`). A entrega das Partes 2 e 3 consolida a camada de persistência Oracle, garante dados de exemplo coerentes com o domínio e adiciona inteligência via PL/SQL integrada às APIs.

Nesta etapa foi construído o modelo lógico/físico no Oracle, exportado o DDL completo, implantadas sequences e índices auxiliares, bem como um conjunto de dados simulados para usuários, posts e interações. A seguir, adicionamos funções e procedures com tratamento de exceções, cursores e loops, expondo-as via endpoints REST consumidos pelo frontend.

Arquitetura resumida:

```
          +------------------+
          |  Angular Frontend|
          |  lead-stats-hub  |
          +---------+--------+
                    |
            HTTPS (API REST)
                    |
          +---------v--------+
          | Spring Boot API  |
          | dashboard-adm    |
          +---------+--------+
                    |
            JDBC / PL/SQL
                    |
          +---------v--------+
          | Oracle Database  |
          | Schema RM563326  |
          +------------------+
```

## Parte 2 — Integração Oracle

### Modelo Lógico/Físico (DER)
- Entidades centrais: `USERS` (usuários autenticados), `POSTS` (publicações), `INTERACTIONS` (likes, comments, shares), `ENGAGEMENT_WEEKLY`, `USER_GROWTH_MONTHLY`, `ALERTS` (alertas gerados por procedures), `USER_ROLES`/`ROLES`.
- DER exportado pelo Oracle SQL Developer Data Modeler está versionado em `db/Diagrama.pdf` e `db/Diagrama(Relatorio).html`.
- Para regenerar/atualizar o diagrama: abrir o schema no SQL Developer Data Modeler, sincronizar com o banco Oracle da FIAP e exportar novamente salvando em `docs/modelo/DER-SmartHAS.pdf` e `docs/modelo/DER-SmartHAS.png`.

### DDL das Tabelas Principais

#### USERS
| Coluna | Tipo | Detalhes |
|--------|------|----------|
| `USER_ID` | NUMBER (identity) | PK, sequence `USER_SEQ` |
| `USER_NAME` | VARCHAR2(100) | Obrigatório |
| `EMAIL` | VARCHAR2(100) | Único |
| `CREATED_AT` | DATE | Default `SYSDATE` |
| `USER_PASSWORD` | VARCHAR2(100) | Senha hash |

```sql
CREATE TABLE "RM563326"."USERS"
   ("USER_ID" NUMBER GENERATED BY DEFAULT ON NULL AS IDENTITY MINVALUE 1 MAXVALUE 9999999999999999999999999999 INCREMENT BY 1 START WITH 1 CACHE 20 NOORDER  NOCYCLE  NOKEEP  NOSCALE ,
    "USER_NAME" VARCHAR2(100 BYTE),
    "EMAIL" VARCHAR2(100 BYTE),
    "CREATED_AT" DATE DEFAULT SYSDATE,
    "USER_PASSWORD" VARCHAR2(100 BYTE)
   ) SEGMENT CREATION IMMEDIATE
  PCTFREE 10 PCTUSED 40 INITRANS 1 MAXTRANS 255
 NOCOMPRESS LOGGING
  STORAGE(INITIAL 65536 NEXT 1048576 MINEXTENTS 1 MAXEXTENTS 2147483645
  PCTINCREASE 0 FREELISTS 1 FREELIST GROUPS 1
  BUFFER_POOL DEFAULT FLASH_CACHE DEFAULT CELL_FLASH_CACHE DEFAULT)
  TABLESPACE "TBSPC_ALUNOS";
```

```sql
ALTER TABLE "RM563326"."USERS" MODIFY ("USER_ID" NOT NULL ENABLE);
ALTER TABLE "RM563326"."USERS" MODIFY ("USER_NAME" NOT NULL ENABLE);
ALTER TABLE "RM563326"."USERS" MODIFY ("EMAIL" NOT NULL ENABLE);
ALTER TABLE "RM563326"."USERS" ADD PRIMARY KEY ("USER_ID")
  USING INDEX TABLESPACE "TBSPC_ALUNOS"  ENABLE;
ALTER TABLE "RM563326"."USERS" ADD UNIQUE ("EMAIL")
  USING INDEX TABLESPACE "TBSPC_ALUNOS"  ENABLE;
```

#### POSTS
| Coluna | Tipo | Detalhes |
|--------|------|----------|
| `POST_ID` | NUMBER (identity) | PK |
| `USER_ID` | NUMBER | FK → `USERS.USER_ID` |
| `TITLE` | VARCHAR2(200) | Título |
| `CONTENT` | CLOB | Corpo |
| `CREATED_AT` | DATE | Default `SYSDATE` |

```sql
CREATE TABLE "RM563326"."POSTS"
   ("POST_ID" NUMBER GENERATED BY DEFAULT ON NULL AS IDENTITY MINVALUE 1 MAXVALUE 9999999999999999999999999999 INCREMENT BY 1 START WITH 1 CACHE 20 NOORDER  NOCYCLE  NOKEEP  NOSCALE ,
    "USER_ID" NUMBER,
    "TITLE" VARCHAR2(200 BYTE),
    "CONTENT" CLOB,
    "CREATED_AT" DATE DEFAULT SYSDATE
   ) SEGMENT CREATION IMMEDIATE
  PCTFREE 10 PCTUSED 40 INITRANS 1 MAXTRANS 255
 NOCOMPRESS LOGGING
  STORAGE(INITIAL 65536 NEXT 1048576 MINEXTENTS 1 MAXEXTENTS 2147483645
  PCTINCREASE 0 FREELISTS 1 FREELIST GROUPS 1
  BUFFER_POOL DEFAULT FLASH_CACHE DEFAULT CELL_FLASH_CACHE DEFAULT)
  TABLESPACE "TBSPC_ALUNOS"
 LOB ("CONTENT") STORE AS SECUREFILE (
  TABLESPACE "TBSPC_ALUNOS" ENABLE STORAGE IN ROW CHUNK 8192
  NOCACHE LOGGING  NOCOMPRESS  KEEP_DUPLICATES
  STORAGE(INITIAL 106496 NEXT 1048576 MINEXTENTS 1 MAXEXTENTS 2147483645
  PCTINCREASE 0
  BUFFER_POOL DEFAULT FLASH_CACHE DEFAULT CELL_FLASH_CACHE DEFAULT));
```

```sql
ALTER TABLE "RM563326"."POSTS" MODIFY ("POST_ID" NOT NULL ENABLE);
ALTER TABLE "RM563326"."POSTS" ADD PRIMARY KEY ("POST_ID")
  USING INDEX TABLESPACE "TBSPC_ALUNOS"  ENABLE;
ALTER TABLE "RM563326"."POSTS" ADD FOREIGN KEY ("USER_ID")
  REFERENCES "RM563326"."USERS"("USER_ID") ENABLE;
```

#### INTERACTIONS
| Coluna | Tipo | Detalhes |
|--------|------|----------|
| `INTERACTION_ID` | NUMBER (identity) | PK |
| `POST_ID` | NUMBER | FK → `POSTS.POST_ID` |
| `USER_ID` | NUMBER | FK → `USERS.USER_ID` |
| `TYPE` | VARCHAR2(20) | CHECK (`LIKE`, `COMMENT`, `SHARE`) |
| `CREATED_AT` | DATE | Default `SYSDATE` |

```sql
CREATE TABLE "RM563326"."INTERACTIONS"
   ("INTERACTION_ID" NUMBER GENERATED BY DEFAULT ON NULL AS IDENTITY MINVALUE 1 MAXVALUE 9999999999999999999999999999 INCREMENT BY 1 START WITH 1 CACHE 20 NOORDER  NOCYCLE  NOKEEP  NOSCALE ,
    "POST_ID" NUMBER,
    "USER_ID" NUMBER,
    "TYPE" VARCHAR2(20 BYTE),
    "CREATED_AT" DATE DEFAULT SYSDATE
   ) SEGMENT CREATION IMMEDIATE
  PCTFREE 10 PCTUSED 40 INITRANS 1 MAXTRANS 255
 NOCOMPRESS LOGGING
  STORAGE(INITIAL 65536 NEXT 1048576 MINEXTENTS 1 MAXEXTENTS 2147483645
  PCTINCREASE 0 FREELISTS 1 FREELIST GROUPS 1
  BUFFER_POOL DEFAULT FLASH_CACHE DEFAULT CELL_FLASH_CACHE DEFAULT)
  TABLESPACE "TBSPC_ALUNOS";
```

```sql
ALTER TABLE "RM563326"."INTERACTIONS" MODIFY ("INTERACTION_ID" NOT NULL ENABLE);
ALTER TABLE "RM563326"."INTERACTIONS" ADD CHECK (TYPE IN ('LIKE', 'COMMENT', 'SHARE')) ENABLE;
ALTER TABLE "RM563326"."INTERACTIONS" ADD PRIMARY KEY ("INTERACTION_ID")
  USING INDEX TABLESPACE "TBSPC_ALUNOS"  ENABLE;
ALTER TABLE "RM563326"."INTERACTIONS" ADD FOREIGN KEY ("POST_ID")
  REFERENCES "RM563326"."POSTS"("POST_ID") ENABLE;
ALTER TABLE "RM563326"."INTERACTIONS" ADD FOREIGN KEY ("USER_ID")
  REFERENCES "RM563326"."USERS"("USER_ID") ENABLE;
```

#### Sequences & Índices relevantes
```sql
CREATE SEQUENCE  "RM563326"."ALERTS_SEQ"  MINVALUE 1 MAXVALUE 9999999999999999999999999999 INCREMENT BY 1 START WITH 4 NOCACHE  NOORDER  NOCYCLE  NOKEEP  NOSCALE  GLOBAL;
CREATE SEQUENCE  "RM563326"."INTERACTION_SEQ"  MINVALUE 1 MAXVALUE 9999999999999999999999999999 INCREMENT BY 1 START WITH 16 NOCACHE  NOORDER  NOCYCLE  NOKEEP  NOSCALE  GLOBAL;
CREATE SEQUENCE  "RM563326"."POST_SEQ"  MINVALUE 1 MAXVALUE 9999999999999999999999999999 INCREMENT BY 1 START WITH 16 NOCACHE  NOORDER  NOCYCLE  NOKEEP  NOSCALE  GLOBAL;
CREATE SEQUENCE  "RM563326"."USER_SEQ"  MINVALUE 1 MAXVALUE 9999999999999999999999999999 INCREMENT BY 1 START WITH 11 NOCACHE  NOORDER  NOCYCLE  NOKEEP  NOSCALE  GLOBAL;
```

```sql
CREATE INDEX "RM563326"."IDX_INTERACTIONS_USER" ON "RM563326"."INTERACTIONS" ("USER_ID") TABLESPACE "TBSPC_ALUNOS";
CREATE INDEX "RM563326"."IDX_INTERACTIONS_POST" ON "RM563326"."INTERACTIONS" ("POST_ID") TABLESPACE "TBSPC_ALUNOS";
CREATE INDEX "RM563326"."IDX_INTER_TYPE_DATE" ON "RM563326"."INTERACTIONS" ("TYPE", "CREATED_AT") TABLESPACE "TBSPC_ALUNOS";
```

### Dados Simulados
- Fonte principal: `db/data.sql` (exportada via Oracle SQL Developer).
- Contém usuários, posts, interações, agregados semanais e alertas.

Exemplos reais:
```sql
Insert into USERS (USER_ID,USER_NAME,EMAIL,CREATED_AT,USER_PASSWORD)
  values ('1','Alice','alice@email.com',to_date('01/03/25','DD/MM/RR'),'$2a$10$N.zmdr9k7uOCQb376NoUnuTJ8iAt6Z5EHsM8lE9lBOsl7iKTVEFDi');
Insert into POSTS (POST_ID,USER_ID,TITLE,CREATED_AT)
  values ('1','1','Primeiro post',to_date('01/06/25','DD/MM/RR'));
Insert into INTERACTIONS (INTERACTION_ID,POST_ID,USER_ID,TYPE,CREATED_AT)
  values ('1','1','2','LIKE',to_date('11/06/25','DD/MM/RR'));
Insert into ENGAGEMENT_WEEKLY (WEEK_ID,START_DATE,END_DATE,TOTAL_LIKES,TOTAL_COMMENTS,TOTAL_SHARES)
  values ('3',to_date('02/06/25','DD/MM/RR'),to_date('08/06/25','DD/MM/RR'),'22','12','9');
```

Execução:
1. Conectar ao Oracle (`sqlplus RM563326/*****@oracle.fiap.com.br:1521/ORCL`).
2. Rodar `@db/schema.sql` e depois `@db/data.sql`.
3. Para ambientes Spring, mantenha `spring.jpa.hibernate.ddl-auto=none` e `app.oracle.bootstrap=true` somente quando quiser recompilar PL/SQL ao subir a aplicação.

### Passo a Passo de Implantação
1. Criar/confirmar schema Oracle (`RM563326`) com privilégios de CREATE TABLE/PROCEDURE/SEQUENCE.
2. Executar `db/schema.sql` (DDL completo).
3. Executar `db/data.sql` para dados simulados.
4. Ajustar credenciais em `src/main/resources/application.properties`:
   ```properties
   spring.datasource.url=jdbc:oracle:thin:@oracle.fiap.com.br:1521:ORCL
   spring.datasource.username=RM563326
   spring.datasource.password=******
   spring.jpa.properties.hibernate.default_schema=RM563326
   app.oracle.bootstrap=true
   ```
5. Subir o Spring Boot (`mvn spring-boot:run`) – o `OracleBootstrap` recompila funções/procedures se a flag estiver ligada.
6. Frontend Angular consome os endpoints via `API_BASE_URL` (`http://localhost:8080`) em `src/app/core/config/api.config.ts`.

## Parte 3 — Funções e Procedures (PL/SQL)

### Functions

#### `AVG_INTERACTIONS_PER_USER()`
- **Assinatura:** `RETURN NUMBER`
- **Regra:** média de interações por usuário ativo no período total.
- **Boas práticas:** comentário de intenção, `NVL`, captura `NO_DATA_FOUND` e `OTHERS`.

```plsql
CREATE OR REPLACE EDITIONABLE FUNCTION "RM563326"."AVG_INTERACTIONS_PER_USER"
RETURN NUMBER IS
  v_avg NUMBER := 0;
BEGIN
  -- Calculates the average number of interactions per user across the platform.
  SELECT AVG(interaction_count)
    INTO v_avg
    FROM (
      SELECT COUNT(*) AS interaction_count
        FROM INTERACTIONS
       GROUP BY USER_ID
    );

  RETURN NVL(v_avg, 0);
EXCEPTION
  WHEN NO_DATA_FOUND THEN
    RETURN 0;
  WHEN OTHERS THEN
    RETURN 0;
END;
```

Uso SQL:
```sql
SELECT AVG_INTERACTIONS_PER_USER() AS avg_interactions FROM dual;
```

#### `FN_AVG_NEW_USERS_PER_MONTH(p_months IN PLS_INTEGER DEFAULT 6)`
- **Retorno:** `NUMBER`
- **Regra:** média de novos usuários por mês nos últimos `p_months` meses.
- **Boas práticas:** comentário, `NVL`, captura de exceções.

```plsql
CREATE OR REPLACE EDITIONABLE FUNCTION "RM563326"."FN_AVG_NEW_USERS_PER_MONTH" (p_months IN PLS_INTEGER DEFAULT 6)
RETURN NUMBER IS
  v_avg NUMBER := 0;
BEGIN
  -- Calculates the average of new users per month within the informed window.
  SELECT AVG(cnt)
    INTO v_avg
    FROM (
      SELECT COUNT(*) AS cnt
        FROM USERS
       WHERE CREATED_AT >= ADD_MONTHS(TRUNC(SYSDATE,'MM'), -p_months + 1)
       GROUP BY TRUNC(CREATED_AT,'MM')
    );

  RETURN NVL(v_avg, 0);
EXCEPTION
  WHEN NO_DATA_FOUND THEN RETURN 0;
  WHEN OTHERS THEN RETURN 0;
END;
```

Uso SQL:
```sql
SELECT FN_AVG_NEW_USERS_PER_MONTH(6) AS avg_new_users FROM dual;
```

#### `FN_DAILY_ENGAGEMENT(p_day IN DATE)`
- **Retorno:** `NUMBER`
- **Regra:** razão entre interações e usuários ativos em um dia.
- **Boas práticas:** comentário, validação `IF`, tratamento `NO_DATA_FOUND/OTHERS`.

```plsql
CREATE OR REPLACE EDITIONABLE FUNCTION "RM563326"."FN_DAILY_ENGAGEMENT" (p_day IN DATE)
RETURN NUMBER IS
  v_interactions NUMBER := 0;
  v_active_users NUMBER := 0;
BEGIN
  -- Engagement rate for a given day (interactions divided by active users).
  SELECT COUNT(*)
    INTO v_interactions
    FROM INTERACTIONS
   WHERE TRUNC(CREATED_AT) = TRUNC(p_day);

  SELECT COUNT(DISTINCT user_id)
    INTO v_active_users
    FROM (
      SELECT user_id FROM POSTS WHERE TRUNC(CREATED_AT) = TRUNC(p_day)
      UNION ALL
      SELECT user_id FROM INTERACTIONS WHERE TRUNC(CREATED_AT) = TRUNC(p_day)
    );

  IF v_active_users = 0 THEN
    RETURN 0;
  END IF;

  RETURN v_interactions / v_active_users;
EXCEPTION
  WHEN NO_DATA_FOUND THEN RETURN 0;
  WHEN OTHERS THEN RETURN 0;
END;
```

Uso SQL:
```sql
SELECT FN_DAILY_ENGAGEMENT(DATE '2025-06-15') AS daily_engagement FROM dual;
```

#### `FN_USER_SUMMARY_JSON(p_user_id IN NUMBER)`
- **Retorno:** `CLOB` (JSON)
- **Regra:** sumariza primeira atividade, total de posts, interações e likes.
- **Boas práticas:** comentário, `JSON_OBJECT`, `TO_CLOB`, tratamento `NO_DATA_FOUND`.

```plsql
CREATE OR REPLACE EDITIONABLE FUNCTION "RM563326"."FN_USER_SUMMARY_JSON" (p_user_id IN NUMBER)
RETURN CLOB IS
  v_posts NUMBER := 0;
  v_interactions NUMBER := 0;
  v_likes NUMBER := 0;
  v_first_seen DATE;
  v_json_vc2 VARCHAR2(32767);
  v_json_clob CLOB;
BEGIN
  -- Returns a JSON payload summarising the user activity.
  SELECT MIN(CREATED_AT)
    INTO v_first_seen
    FROM USERS
   WHERE USER_ID = p_user_id;

  SELECT COUNT(*) INTO v_posts FROM POSTS WHERE USER_ID = p_user_id;
  SELECT COUNT(*) INTO v_interactions FROM INTERACTIONS WHERE USER_ID = p_user_id;
  SELECT COUNT(*) INTO v_likes FROM INTERACTIONS WHERE USER_ID = p_user_id AND UPPER(TYPE) = 'LIKE';

  SELECT JSON_OBJECT(
           KEY 'userId' VALUE p_user_id,
           KEY 'firstSeen' VALUE TO_CHAR(v_first_seen,'YYYY-MM-DD" "HH24:MI:SS'),
           KEY 'posts' VALUE v_posts,
           KEY 'interactions' VALUE v_interactions,
           KEY 'likes' VALUE v_likes
         )
    INTO v_json_vc2
    FROM dual;

  v_json_clob := TO_CLOB(v_json_vc2);
  RETURN v_json_clob;
EXCEPTION
  WHEN NO_DATA_FOUND THEN RETURN TO_CLOB('{"error":"USER_NOT_FOUND"}');
  WHEN OTHERS THEN RETURN TO_CLOB('{"error":"' || REPLACE(SUBSTR(SQLERRM,1,1000),'"','\"') || '"}');
END;
```

Uso SQL:
```sql
SELECT FN_USER_SUMMARY_JSON(3) AS summary_json FROM dual;
```

### Procedures

#### `PROC_EVALUATE_ENGAGEMENT_SENSORS(p_from IN DATE, p_to IN DATE, p_multiplier IN NUMBER DEFAULT 3)`
- **Propósito:** comparar taxa atual × baseline, identificar pico diário via cursor e gravar alertas.
- **Fluxo:** valida janela (`IF`), calcula baseline, percorre cursor `c_daily_interactions` com `FOR`/`LOOP`, persiste alerta ou registrador de erro (`EXCEPTION`).

```plsql
CREATE OR REPLACE EDITIONABLE PROCEDURE "RM563326"."PROC_EVALUATE_ENGAGEMENT_SENSORS" (
  p_from IN DATE,
  p_to IN DATE,
  p_multiplier IN NUMBER DEFAULT 3
) AS
  /*
    Procedure: PROC_EVALUATE_ENGAGEMENT_SENSORS
    Purpose : Evaluate interaction rates in a period and persist alerts when a spike is detected.
    Notes   : Uses a cursor to inspect the busiest day inside the window.
  */
  CURSOR c_daily_interactions IS
    SELECT TRUNC(created_at) AS interaction_day,
           COUNT(*) AS interactions_qtd
      FROM INTERACTIONS
     WHERE CREATED_AT >= p_from
       AND CREATED_AT < p_to
     GROUP BY TRUNC(created_at);
  v_current_rate NUMBER := 0;
  v_baseline NUMBER := 0;
  v_peak_date DATE;
  v_peak_total NUMBER := 0;
  v_details_vc2 VARCHAR2(32767);
  v_details_clob CLOB;
  v_alert_id NUMBER;
BEGIN
  IF p_from IS NULL OR p_to IS NULL OR p_to <= p_from THEN
    RAISE_APPLICATION_ERROR(-20001,'Janela invalida');
  END IF;

  SELECT NVL(COUNT(*),0)/GREATEST(((p_to - p_from) * 24),1)
    INTO v_current_rate
    FROM INTERACTIONS
   WHERE CREATED_AT >= p_from
     AND CREATED_AT < p_to;

  SELECT NVL(COUNT(*),0)/GREATEST(((p_from - (p_from - 7)) * 24),1)
    INTO v_baseline
    FROM INTERACTIONS
   WHERE CREATED_AT >= (p_from - 7)
     AND CREATED_AT < p_from;

  IF v_baseline = 0 AND v_current_rate > 0 THEN
    v_baseline := 0.1;
  END IF;

  FOR daily_rec IN c_daily_interactions LOOP
    IF daily_rec.interactions_qtd > v_peak_total THEN
      v_peak_total := daily_rec.interactions_qtd;
      v_peak_date := daily_rec.interaction_day;
    END IF;
  END LOOP;

  IF v_current_rate >= p_multiplier * v_baseline THEN
    SELECT JSON_OBJECT(
             KEY 'from' VALUE TO_CHAR(p_from,'YYYY-MM-DD" "HH24:MI:SS'),
             KEY 'to' VALUE TO_CHAR(p_to,'YYYY-MM-DD" "HH24:MI:SS'),
             KEY 'currentRate' VALUE v_current_rate,
             KEY 'baseline' VALUE v_baseline,
             KEY 'multiplier' VALUE p_multiplier,
             KEY 'peakDay' VALUE TO_CHAR(v_peak_date,'YYYY-MM-DD'),
             KEY 'peakInteractions' VALUE v_peak_total
           )
      INTO v_details_vc2
      FROM dual;

    v_details_clob := TO_CLOB(v_details_vc2);
    v_alert_id := ALERTS_SEQ.NEXTVAL;

    INSERT INTO ALERTS(ALERT_ID,ALERT_TYPE,SEVERITY,DETAILS,CREATED_AT)
    VALUES(v_alert_id,'ENGAGEMENT_SPIKE','HIGH',v_details_clob,SYSDATE);
  END IF;
EXCEPTION
  WHEN OTHERS THEN
    v_details_clob := TO_CLOB('{'||
      '"error":"' || REPLACE(SUBSTR(SQLERRM,1,1000),'"','\"') || '",'||
      '"from":"' || TO_CHAR(p_from,'YYYY-MM-DD" "HH24:MI:SS') || '",'||
      '"to":"'   || TO_CHAR(p_to  ,'YYYY-MM-DD" "HH24:MI:SS') || '",'||
      '"multiplier":' || NVL(TO_CHAR(p_multiplier),'null') ||
      '}'
    );

    INSERT INTO ALERTS(ALERT_ID,ALERT_TYPE,SEVERITY,DETAILS,CREATED_AT)
    VALUES(ALERTS_SEQ.NEXTVAL,'ENGAGEMENT_SPIKE_ERROR','LOW',v_details_clob,SYSDATE);
END;
```

- **Acionamento backend:** `POST /api/admin/run-alerts` → `AdminController.runAlerts()` → `OracleProcService.runEngagementSensors()`. Resposta JSON típica:
```json
{"status":"ok","from":"2025-06-01T00:00","to":"2025-06-07T00:00","multiplier":3}
```

#### `PROC_USER_CONSUMPTION_REPORT(p_user_id IN NUMBER, p_from IN DATE, p_to IN DATE, p_out OUT SYS_REFCURSOR)`
- **Propósito:** consolidar métricas de consumo por usuário (posts, likes, comments, shares) e devolver via cursor.
- **Fluxo:** valida parâmetros (`IF`), agrega counts em loop sobre `summary_rec`, monta `OPEN ... FOR` com resultado ou payload de erro.

```plsql
CREATE OR REPLACE EDITIONABLE PROCEDURE "RM563326"."PROC_USER_CONSUMPTION_REPORT" (
  p_user_id IN NUMBER,
  p_from IN DATE,
  p_to IN DATE,
  p_out OUT SYS_REFCURSOR
) AS
  /*
    Procedure: PROC_USER_CONSUMPTION_REPORT
    Purpose : Produce a consumption summary per user and period, returning a cursor for integration.
    Notes   : Aggregates interaction types inside a loop for clarity.
  */
  v_posts NUMBER := 0;
  v_interactions NUMBER := 0;
  v_likes NUMBER := 0;
  v_comments NUMBER := 0;
  v_shares NUMBER := 0;
  v_errmsg VARCHAR2(2000);
BEGIN
  IF p_user_id IS NULL OR p_from IS NULL OR p_to IS NULL OR p_to <= p_from THEN
    RAISE_APPLICATION_ERROR(-20002,'Parametros invalidos');
  END IF;

  SELECT COUNT(*)
    INTO v_posts
    FROM POSTS
   WHERE USER_ID = p_user_id
     AND CREATED_AT >= p_from
     AND CREATED_AT < p_to;

  FOR summary_rec IN (
    SELECT UPPER(TYPE) AS interaction_type,
           COUNT(*) AS total
      FROM INTERACTIONS
     WHERE USER_ID = p_user_id
       AND CREATED_AT >= p_from
       AND CREATED_AT < p_to
     GROUP BY UPPER(TYPE)
  ) LOOP
    CASE summary_rec.interaction_type
      WHEN 'LIKE' THEN
        v_likes := summary_rec.total;
      WHEN 'COMMENT' THEN
        v_comments := summary_rec.total;
      WHEN 'SHARE' THEN
        v_shares := summary_rec.total;
    END CASE;
  END LOOP;

  v_interactions := v_likes + v_comments + v_shares;

  OPEN p_out FOR
    SELECT p_user_id AS USER_ID,
           p_from AS PERIOD_FROM,
           p_to AS PERIOD_TO,
           v_posts AS POSTS_COUNT,
           v_interactions AS INTERACTIONS_COUNT,
           v_likes AS LIKES_COUNT,
           v_comments AS COMMENTS_COUNT,
           v_shares AS SHARES_COUNT,
           CASE WHEN v_interactions = 0 THEN 0 ELSE v_likes / v_interactions END AS LIKE_RATIO
      FROM dual;
EXCEPTION
  WHEN OTHERS THEN
    v_errmsg := REPLACE(SUBSTR(SQLERRM,1,2000),'"','\"');
    OPEN p_out FOR
      SELECT p_user_id AS USER_ID,
             p_from AS PERIOD_FROM,
             p_to AS PERIOD_TO,
             -1 AS POSTS_COUNT,
             -1 AS INTERACTIONS_COUNT,
             -1 AS LIKES_COUNT,
             -1 AS COMMENTS_COUNT,
             -1 AS SHARES_COUNT,
             0 AS LIKE_RATIO,
             v_errmsg AS ERROR_MSG
        FROM dual;
END;
```

- **Acionamento backend:** `POST /api/admin/user-consumption` → `OracleProcService.userConsumptionReport()`.
- **Resposta JSON exemplo:**
```json
{
  "userId": 3,
  "from": "2025-06-01T00:00:00",
  "to": "2025-06-30T00:00:00",
  "posts": 3,
  "interactions": 5,
  "likes": 3,
  "comments": 1,
  "shares": 1,
  "likeRatio": 0.6
}
```

### Integração Java ⇄ Oracle

Fluxo REST completo:
1. **Controller** (`AdminController`, `AdvancedMetricsController`) expõe endpoints `/api/admin/*` e `/api/metrics/*`.
2. **Service** (`OracleProcService`, `OracleProcedureService`) abstraem chamadas JDBC/`JdbcTemplate`.
3. **Bootstrap** (`OracleBootstrap`) recompila objetos PL/SQL quando `app.oracle.bootstrap=true`.

Snippets relevantes:
```java
// src/main/java/com/vini334/dashboard/infrastructure/oracle/OracleProcService.java
try (Connection cn = dataSource.getConnection();
     CallableStatement cs = cn.prepareCall("{ call PROC_USER_CONSUMPTION_REPORT(?, ?, ?, ?) }") ) {
  cs.setLong(1, userId);
  cs.setTimestamp(2, from);
  cs.setTimestamp(3, to);
  cs.registerOutParameter(4, Types.REF_CURSOR);
  cs.execute();
  try (ResultSet rs = (ResultSet) cs.getObject(4)) {
    if (rs != null && rs.next()) {
      body.put("likes", rs.getLong("LIKES_COUNT"));
      body.put("comments", rs.getLong("COMMENTS_COUNT"));
      body.put("shares", rs.getLong("SHARES_COUNT"));
    }
  }
}
```

```java
// src/main/java/com/vini334/dashboard/service/OracleProcedureService.java
public Double getAvgNewUsersPerMonth(int months) {
    return jdbcTemplate.queryForObject(
            "SELECT FN_AVG_NEW_USERS_PER_MONTH(?) FROM DUAL",
            Double.class,
            months
    );
}
```

Propriedades de datasource (Oracle Thin Driver) estão em `src/main/resources/application.properties`. O frontend aponta para o backend via `API_BASE_URL` (`http://localhost:8080`) em `src/app/core/config/api.config.ts`, consumindo `GET /api/metrics/*` para montar gráficos (ver `DashboardService`).

## Testes & Evidências

### cURL de referência
```bash
# Login (gera JWT)
curl -X POST http://localhost:8080/api/auth/login \
  -H "Content-Type: application/x-www-form-urlencoded" \
  -d "email=admin@test.com&password=123456"

# Criar post
curl -X POST http://localhost:8080/api/posts \
  -H "Content-Type: application/json" \
  -d '{"title":"Sensores atualizados","content":"Leitura 2025-06-26"}' \
  -G -d "userId=1"

# Registrar interação
curl -X POST http://localhost:8080/api/interactions \
  -H "Content-Type: application/json" \
  -d '{"postId":1,"userId":2,"type":"like"}'

# Relatório Oracle (procedure)
curl -X POST "http://localhost:8080/api/admin/user-consumption" \
  -d "userId=3" \
  -d "from=2025-06-01T00:00:00" \
  -d "to=2025-06-30T00:00:00"

# Funções de métricas
curl "http://localhost:8080/api/metrics/avg-new-users?months=6"
curl "http://localhost:8080/api/metrics/user-summary?userId=3"
```

### Exemplo de respostas JSON
- `POST /api/admin/run-alerts`:
```json
{"status":"ok","from":"2025-06-01T00:00","to":"2025-06-07T00:00","multiplier":3}
```
- `GET /api/metrics/avg-interactions`:
```json
2.4
```
- `GET /api/metrics/user-summary?userId=3`:
```json
{
  "userId": 3,
  "firstSeen": "2025-04-10 00:00:00",
  "posts": 3,
  "interactions": 5,
  "likes": 3
}
```

> Não há `docs/tests.md` ou scripts de teste automatizado no repositório; os comandos acima reproduzem os cenários de ponta a ponta.

## Checklist de Conformidade
- ✅ Modelo lógico/físico Oracle atualizado (`USERS`, `POSTS`, `INTERACTIONS`, agregados) e DER versionado.
- ✅ DDL e sequences implantadas via `db/schema.sql`.
- ✅ Dados simulados (usuários, posts, métricas) em `db/data.sql`.
- ✅ Funções PL/SQL (indicadores + JSON) com `EXCEPTION` e comentários.
- ✅ Procedures com `IF`, `LOOP`, `CURSOR` e integração REST (`/api/admin/run-alerts`, `/api/admin/user-consumption`).
- ✅ Integração Java ⇄ Oracle documentada (Controllers → Services → PL/SQL).
- ✅ Frontend Angular apontando para `/api/metrics` e consumindo métricas Oracle.
- ✅ Evidências de execução (`mvn clean install`, cURL reproduzíveis).

## Troubleshooting
| Sintoma | Possível causa | Diagnóstico | Correção |
|---------|----------------|-------------|----------|
| ORA-01017 ao aplicar scripts | Credenciais incorretas | `sqlplus user/pass@host` | Verificar usuário `RM563326` e resetar senha |
| ORA-01950 / privilégios insuficientes | Tablespace sem quota | `SELECT * FROM user_ts_quotas;` | Solicitar aumento de quota em `TBSPC_ALUNOS` |
| `ALERTS_SEQ` não existe ao subir Spring | Schema vazio / scripts não rodados | Ver logs `[OracleBootstrap]` | Executar `db/schema.sql` ou manter `app.oracle.bootstrap=true` |
| `HTTP 401` nos endpoints admin | Falta de token ou usuário inexistente | Verificar `POST /api/auth/login` | Incluir JWT no header `Authorization: Bearer <token>` |
| `HTTP 400` com mensagens “Janela invalida” | Datas `from/to` invertidas | Validar formato ISO `2025-06-01T00:00:00` | Ajustar payload |
| Divergência de timezone | Ambiente local vs DB | Comparar `SELECT SYSDATE FROM dual;` e logs Spring | Normalizar uso de `LocalDateTime` (ISO-8601) |

## Apêndice

### Tabelas auxiliares, índices e grants
- `USER_ROLES`, `ROLES`, `ENGAGEMENT_WEEKLY`, `USER_GROWTH_MONTHLY`, `ALERTS` (detalhes completos em `db/schema.sql`).
- Índices `IDX_INTERACTIONS_USER`, `IDX_INTER_TYPE_DATE`, `IDX_ENGAGEMENT_WEEKLY_START_END` aceleram dashboards.
- `OracleBootstrap` recompila funções/procedures automaticamente no start quando habilitado.

### Changelog recente
- `db/schema.sql:533-703` – Procedures `PROC_EVALUATE_ENGAGEMENT_SENSORS` e `PROC_USER_CONSUMPTION_REPORT` reescritas com cursores, loops e JSON detalhado.
- `db/schema.sql:707-870` – Functions `AVG_INTERACTIONS_PER_USER`, `FN_AVG_NEW_USERS_PER_MONTH`, `FN_DAILY_ENGAGEMENT`, `FN_USER_SUMMARY_JSON` documentadas e normalizadas.
- `src/main/java/com/vini334/dashboard/infrastructure/oracle/OracleBootstrap.java:56-243` – Strings PL/SQL alinhadas ao schema exportado.
- `src/main/java/com/vini334/dashboard/infrastructure/oracle/OracleProcService.java:33-74` – Mapeamento JDBC incluindo `comments` e `shares`.
- `src/main/java/com/vini334/dashboard/service/OracleProcedureService.java:25-68` – Métodos `JdbcTemplate` para cada function Oracle.

### Referências internas
- `db/schema.sql`
- `db/data.sql`
- `db/Diagrama.pdf`
- `DB_SETUP.md`
- `src/main/java/com/vini334/dashboard/web/AdminController.java`
- `src/main/java/com/vini334/dashboard/controller/AdvancedMetricsController.java`
- `src/main/java/com/vini334/dashboard/infrastructure/oracle/OracleProcService.java`
- `src/main/java/com/vini334/dashboard/service/OracleProcedureService.java`
- `src/main/resources/application.properties`
- `ProjetoAngular/lead-stats-hub-ng/src/app/core/config/api.config.ts`
- `ProjetoAngular/lead-stats-hub-ng/src/app/services/dashboard.service.ts`
